networks:
  mc_network_1:
    driver: bridge
services:
  prep_data_instance_1:
    image: busybox:latest
    command:
    - sh
    - -c
    - mkdir -p /data /data/plugins /data/skins && chmod 777 /data /data/plugins /data/skins
      && if [ -d /source_plugins ] && [ -n "$(ls -A /source_plugins 2>/dev/null)"
      ]; then   cp -r /source_plugins/. /data/plugins/; fi; if [ -d /source_skins
      ] && [ -n "$(ls -A /source_skins 2>/dev/null)" ]; then   cp -r /source_skins/.
      /data/skins/; fi; chmod -R 777 /data/plugins /data/skins
    volumes:
    - /mnt/data/tmeehan/mc_multiplayer_demo/eval_all_combined/data/1:/data
    - /home/tmeehan/snap/snapd-desktop-integration/315/Repos/mc-multiplayer-data/plugins:/source_plugins:ro
    - /home/tmeehan/snap/snapd-desktop-integration/315/Repos/mc-multiplayer-data/skins:/source_skins:ro
    restart: 'no'
  mc_instance_1:
    depends_on:
      prep_data_instance_1:
        condition: service_completed_successfully
    image: itzg/minecraft-server
    tty: true
    network_mode: host
    environment:
      EULA: 'TRUE'
      VERSION: '1.21'
      TYPE: PAPER
      MODE: survival
      RCON_PORT: 25601
      SERVER_PORT: 25591
      ALLOW_FLIGHT: true
      ONLINE_MODE: false
      SPAWN_PROTECTION: 0
      SEED: solaris
      ENFORCE_SECURE_PROFILE: false
      OPS: Pengulu,Ahrae,timwm
      RCON_PASSWORD: research
      BROADCAST_RCON_TO_OPS: true
    volumes:
    - /mnt/data/tmeehan/mc_multiplayer_demo/eval_all_combined/data/1:/data
    healthcheck:
      test:
      - CMD-SHELL
      - mc-monitor status --host localhost --port 25591
      interval: 10s
      timeout: 5s
      retries: 12
  sender_alpha_instance_1:
    image: ojmichel/mc-multiplayer-base:latest
    build:
      context: /home/tmeehan/snap/snapd-desktop-integration/315/Repos/mc-multiplayer-data
      dockerfile: Dockerfile
    depends_on:
      mc_instance_1:
        condition: service_healthy
      receiver_alpha_instance_1:
        condition: service_started
    volumes:
    - /mnt/data/tmeehan/mc_multiplayer_demo/eval_all_combined/output:/output
    environment:
      BOT_NAME: Alpha
      OTHER_BOT_NAME: Bravo
      RECEIVER_HOST: receiver_alpha_instance_1
      RECEIVER_PORT: 8110
      COORD_PORT: 8120
      OTHER_COORD_HOST: sender_bravo_instance_1
      OTHER_COORD_PORT: 8120
      BOT_RNG_SEED: '12346'
      EPISODES_NUM: 6
      EPISODE_START_ID: 0
      EPISODE_TYPES: turnToLookEval,turnToLookOppositeEval
      MC_HOST: host.docker.internal
      MC_PORT: 25591
      RCON_HOST: host.docker.internal
      RCON_PORT: 25601
      RCON_PASSWORD: research
      BOOTSTRAP_WAIT_TIME: 60
      ENABLE_CAMERA_WAIT: 1
      CAMERA_READY_RETRIES: 300
      CAMERA_READY_CHECK_INTERVAL: 2000
      ITERATIONS_NUM_PER_EPISODE: 1
      MC_VERSION: '1.21'
      VIEWER_RENDERING_DISABLED: 0
      VIEWER_RECORDING_INTERVAL: 50
      WALK_TIMEOUT: 5
      TELEPORT: 1
      TELEPORT_RADIUS: 50000
      WORLD_TYPE: normal
      SMOKE_TEST: 0
      INSTANCE_ID: 1
      OUTPUT_DIR: /output
      EVAL_TIME_SET_DAY: 1
      ENABLE_DEMO_MODE: '0'
      ENABLE_DEMO_CAMERA: '1'
    extra_hosts:
    - host.docker.internal:host-gateway
    networks:
    - mc_network_1
    command: ./entrypoint_senders.sh
  sender_bravo_instance_1:
    image: ojmichel/mc-multiplayer-base:latest
    build:
      context: /home/tmeehan/snap/snapd-desktop-integration/315/Repos/mc-multiplayer-data
      dockerfile: Dockerfile
    depends_on:
      mc_instance_1:
        condition: service_healthy
      receiver_bravo_instance_1:
        condition: service_started
      sender_alpha_instance_1:
        condition: service_started
    volumes:
    - /mnt/data/tmeehan/mc_multiplayer_demo/eval_all_combined/output:/output
    environment:
      BOT_NAME: Bravo
      OTHER_BOT_NAME: Alpha
      RECEIVER_HOST: receiver_bravo_instance_1
      RECEIVER_PORT: 8110
      COORD_PORT: 8120
      OTHER_COORD_HOST: sender_alpha_instance_1
      OTHER_COORD_PORT: 8120
      BOT_RNG_SEED: '12346'
      EPISODES_NUM: 6
      EPISODE_START_ID: 0
      EPISODE_TYPES: turnToLookEval,turnToLookOppositeEval
      MC_HOST: host.docker.internal
      MC_PORT: 25591
      RCON_HOST: host.docker.internal
      RCON_PORT: 25601
      RCON_PASSWORD: research
      BOOTSTRAP_WAIT_TIME: 60
      ENABLE_CAMERA_WAIT: 1
      CAMERA_READY_RETRIES: 300
      CAMERA_READY_CHECK_INTERVAL: 2000
      ITERATIONS_NUM_PER_EPISODE: 1
      MC_VERSION: '1.21'
      VIEWER_RENDERING_DISABLED: 0
      VIEWER_RECORDING_INTERVAL: 50
      WALK_TIMEOUT: 5
      TELEPORT: 1
      TELEPORT_RADIUS: 250
      WORLD_TYPE: normal
      SMOKE_TEST: 0
      INSTANCE_ID: 1
      OUTPUT_DIR: /output
      EVAL_TIME_SET_DAY: 1
      ENABLE_DEMO_MODE: '0'
      ENABLE_DEMO_CAMERA: '1'
    extra_hosts:
    - host.docker.internal:host-gateway
    networks:
    - mc_network_1
    command: ./entrypoint_senders.sh
  receiver_alpha_instance_1:
    image: ojmichel/mc-multiplayer-base:latest
    environment:
      PORT: 8110
      NAME: Alpha
      INSTANCE_ID: 1
      EPISODE_START_ID: 0
      VIEWER_RENDERING_DISABLED: 0
    tty: true
    volumes:
    - /mnt/data/tmeehan/mc_multiplayer_demo/eval_all_combined/output:/output
    networks:
    - mc_network_1
    command: ./entrypoint_receiver.sh
  receiver_bravo_instance_1:
    image: ojmichel/mc-multiplayer-base:latest
    environment:
      PORT: 8110
      NAME: Bravo
      INSTANCE_ID: 1
      EPISODE_START_ID: 0
      VIEWER_RENDERING_DISABLED: 0
    tty: true
    volumes:
    - /mnt/data/tmeehan/mc_multiplayer_demo/eval_all_combined/output:/output
    networks:
    - mc_network_1
    command: ./entrypoint_receiver.sh
  camera_alpha_instance_1:
    image: ojmichel/mineflayer-spectator-client:gpu
    build:
      context: /home/tmeehan/snap/snapd-desktop-integration/315/Repos/mc-multiplayer-data/camera
      dockerfile: Dockerfile.gpu
    restart: unless-stopped
    network_mode: host
    depends_on:
      mc_instance_1:
        condition: service_healthy
    environment:
      MC_VERSION: '1.21'
      MC_HOST: 127.0.0.1
      MC_PORT: 25591
      CAMERA_NAME: CameraAlpha
      DISPLAY: :102
      VNC_PORT: '5904'
      NOVNC_PORT: '6904'
      WIDTH: '1280'
      HEIGHT: '720'
      FPS: '20'
      VNC_PASSWORD: research
      ENABLE_RECORDING: '1'
      RECORDING_PATH: /output/camera_alpha.mkv
      RENDER_DISTANCE: '8'
      SIMULATION_DISTANCE: '4'
      GRAPHICS_MODE: '1'
      NVIDIA_DRIVER_CAPABILITIES: all
      NVIDIA_VISIBLE_DEVICES: 0
    runtime: nvidia
    volumes:
    - /mnt/data/tmeehan/mc_multiplayer_demo/eval_all_combined/camera/data_alpha/1:/root
    - /mnt/data/tmeehan/mc_multiplayer_demo/eval_all_combined/camera/output_alpha/1:/output
  episode_starter_instance_1:
    image: node:20
    network_mode: host
    depends_on:
      mc_instance_1:
        condition: service_healthy
      camera_alpha_instance_1:
        condition: service_started
      camera_demo_instance_1:
        condition: service_started
    working_dir: /app
    environment:
      RCON_HOST: 127.0.0.1
      RCON_PORT: 25601
      RCON_PASSWORD: research
      EPISODE_START_RETRIES: '300'
      EPISODE_REQUIRED_PLAYERS: Alpha,CameraAlpha,Bravo,CameraBravo,CameraDemo,SpectatorAlpha,SpectatorBravo
      EPISODE_START_COMMAND: episode start Alpha CameraAlpha technoblade.png Bravo
        CameraBravo test.png
      EPISODE_START_ID: '0'
      DEMO_CAMERA_NAME: CameraDemo
    volumes:
    - /home/tmeehan/snap/snapd-desktop-integration/315/Repos/mc-multiplayer-data/camera/episode_starter.js:/app/episode_starter.js:ro
    - /home/tmeehan/snap/snapd-desktop-integration/315/Repos/mc-multiplayer-data/camera/package.json:/app/package.json:ro
    command:
    - sh
    - -c
    - npm install --omit=dev --no-progress && node episode_starter.js
  camera_bravo_instance_1:
    image: ojmichel/mineflayer-spectator-client:gpu
    build:
      context: /home/tmeehan/snap/snapd-desktop-integration/315/Repos/mc-multiplayer-data/camera
      dockerfile: Dockerfile.gpu
    restart: unless-stopped
    network_mode: host
    depends_on:
      mc_instance_1:
        condition: service_healthy
    environment:
      MC_VERSION: '1.21'
      MC_HOST: 127.0.0.1
      MC_PORT: 25591
      CAMERA_NAME: CameraBravo
      DISPLAY: :103
      VNC_PORT: '5905'
      NOVNC_PORT: '6905'
      WIDTH: '1280'
      HEIGHT: '720'
      FPS: '20'
      VNC_PASSWORD: research
      ENABLE_RECORDING: '1'
      RECORDING_PATH: /output/camera_bravo.mkv
      RENDER_DISTANCE: '8'
      SIMULATION_DISTANCE: '4'
      GRAPHICS_MODE: '1'
      NVIDIA_DRIVER_CAPABILITIES: all
      NVIDIA_VISIBLE_DEVICES: 0
    runtime: nvidia
    volumes:
    - /mnt/data/tmeehan/mc_multiplayer_demo/eval_all_combined/camera/data_bravo/1:/root
    - /mnt/data/tmeehan/mc_multiplayer_demo/eval_all_combined/camera/output_bravo/1:/output
  camera_demo_instance_1:
    image: ojmichel/mineflayer-spectator-client:gpu
    build:
      context: /home/tmeehan/snap/snapd-desktop-integration/315/Repos/mc-multiplayer-data/camera
      dockerfile: Dockerfile.gpu
    restart: unless-stopped
    network_mode: host
    depends_on:
      mc_instance_1:
        condition: service_healthy
    environment:
      MC_VERSION: '1.21'
      MC_HOST: 127.0.0.1
      MC_PORT: 25591
      CAMERA_NAME: CameraDemo
      DISPLAY: :104
      VNC_PORT: '5906'
      NOVNC_PORT: '6906'
      WIDTH: '2560'
      HEIGHT: '1440'
      FPS: '20'
      VNC_PASSWORD: research
      ENABLE_RECORDING: '1'
      RECORDING_PATH: /output/camera_demo.mkv
      RENDER_DISTANCE: '8'
      SIMULATION_DISTANCE: '4'
      GRAPHICS_MODE: '1'
      FOV: '45'
      NVENC_PRESET: p7
      NVENC_TUNE: hq
      NVIDIA_DRIVER_CAPABILITIES: all
      NVIDIA_VISIBLE_DEVICES: 0
    runtime: nvidia
    volumes:
    - /mnt/data/tmeehan/mc_multiplayer_demo/eval_all_combined/camera/data_demo/1:/root
    - /mnt/data/tmeehan/mc_multiplayer_demo/eval_all_combined/camera/output_demo/1:/output
  spectator_alpha_instance_1:
    image: ojmichel/mc-multiplayer-base:latest
    build:
      context: /home/tmeehan/snap/snapd-desktop-integration/315/Repos/mc-multiplayer-data
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      mc_instance_1:
        condition: service_healthy
    working_dir: /usr/src/app
    environment:
      MC_HOST: host.docker.internal
      MC_PORT: 25591
      MC_USERNAME: SpectatorAlpha
    extra_hosts:
    - host.docker.internal:host-gateway
    networks:
    - mc_network_1
    command:
    - node
    - spectator/spectator.js
  spectator_bravo_instance_1:
    image: ojmichel/mc-multiplayer-base:latest
    build:
      context: /home/tmeehan/snap/snapd-desktop-integration/315/Repos/mc-multiplayer-data
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      mc_instance_1:
        condition: service_healthy
    working_dir: /usr/src/app
    environment:
      MC_HOST: host.docker.internal
      MC_PORT: 25591
      MC_USERNAME: SpectatorBravo
    extra_hosts:
    - host.docker.internal:host-gateway
    networks:
    - mc_network_1
    command:
    - node
    - spectator/spectator.js
