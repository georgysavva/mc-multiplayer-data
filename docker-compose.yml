services:
  prep_data:
    image: busybox:latest
    command:
      - sh
      - -c
      - |
        mkdir -p /data /data/plugins /data/skins &&
        chmod 777 /data /data/plugins /data/skins &&
        if [ -d /source_plugins ] && [ -n "$(ls -A /source_plugins 2>/dev/null)" ]; then
          cp -r /source_plugins/. /data/plugins/;
        fi;
        if [ -d /source_skins ] && [ -n "$(ls -A /source_skins 2>/dev/null)" ]; then
          cp -r /source_skins/. /data/skins/;
        fi;
        chmod -R 777 /data/plugins /data/skins
    volumes:
      - ${MC_DATA_DIR:-./data}:/data
      - ./plugins:/source_plugins:ro
      - ./skins:/source_skins:ro
    restart: "no"

  mc:
    depends_on:
      prep_data:
        condition: service_completed_successfully
    image: itzg/minecraft-server
    tty: true
    network_mode: host # this is needed because otherwise it cannot download the server zip file on certain machines
    environment:
      EULA: "TRUE"
      VERSION: 1.20.4
      TYPE: PAPER
      MODE: survival
      ONLINE_MODE: false
      ENFORCE_SECURE_PROFILE: false
      SERVER_PORT: ${MC_SERVER_PORT:-25565}
      RCON_PORT: ${MC_RCON_PORT:-25575}
      RCON_PASSWORD: research
      BROADCAST_RCON_TO_OPS: true
      SPAWN_PROTECTION: 0
      ALLOW_FLIGHT: true
      SEED: ${WORLD_SEED:-1234567890}
      # MODRINTH_PROJECTS: skinsrestorer,luckperms
      # LEVEL_TYPE: "minecraft:single_biome_surface"
      # GENERATOR_SETTINGS: '{"biome":"minecraft:plains"}'
      LEVEL_TYPE: minecraft:${LEVEL_TYPE:-flat}
      # below should be irrelevant if LEVEL_TYPE is not minecraft:flat
      GENERATOR_SETTINGS: >-
        {
          "layers": [
            { "block": "minecraft:bedrock", "height": 1 },
            { "block": "minecraft:stone",   "height": 124 },
            { "block": "minecraft:dirt",    "height": 2 },
            { "block": "minecraft:grass_block", "height": 1 }
          ],
          "biome": "minecraft:plains"
        }
    volumes:
      # attach the relative directory 'data' to the container's /data path
      - ${MC_DATA_DIR:-./data}:/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "mc-monitor status --host localhost --port ${MC_SERVER_PORT:-25565}",
        ]
      interval: 10s
      timeout: 5s
      retries: 12

  sender_alpha:
    image: ojmichel/mc-multiplayer-base:latest
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      mc:
        condition: service_healthy
      receiver_alpha:
        condition: service_started
    volumes:
      # share the output directory with the host
      - ./output:/output
    environment:
      BOT_NAME: Alpha
      OTHER_BOT_NAME: Bravo
      RECEIVER_HOST: receiver_alpha
      RECEIVER_PORT: 8090
      COORD_PORT: 8100
      OTHER_COORD_HOST: sender_bravo
      OTHER_COORD_PORT: 8100
      BOT_RNG_SEED: "123456"
      EPISODE_TYPES: ${EPISODE_TYPES:-all}
      EPISODES_NUM: ${EPISODES_NUM:-1}
      EPISODE_START_ID: ${EPISODE_START_ID:-0}
      MC_HOST: host.docker.internal
      MC_PORT: ${MC_SERVER_PORT:-25565}
      RCON_HOST: host.docker.internal
      RCON_PORT: ${MC_RCON_PORT:-25575}
      RCON_PASSWORD: research
      WALK_TIMEOUT: 5
      TELEPORT: 1
      TELEPORT_CENTER_X: 0
      TELEPORT_CENTER_Z: 0
      TELEPORT_RADIUS: 3000
      TELEPORT_MIN_DISTANCE: 1000
      BOOTSTRAP_WAIT_TIME: 1
      TELEPORT: ${TELEPORT:-1}
      TELEPORT_RADIUS: ${TELEPORT_RADIUS:-5}
      BOOTSTRAP_WAIT_TIME: ${BOOTSTRAP_WAIT_TIME:-1}
      ENABLE_CAMERA_WAIT: 1
      ITERATIONS_NUM_PER_EPISODE: 5
      MC_VERSION: "1.20.4"
      CAMERA_READY_RETRIES: 300
      CAMERA_READY_CHECK_INTERVAL: 2000
      VIEWER_RENDERING_DISABLED: 1
      VIEWER_RECORDING_INTERVAL: 50 # should be 50 when rendering is disabled to have 20 FPS
      WORLD_TYPE: ${LEVEL_TYPE:-flat}
      SMOKE_TEST: ${SMOKE_TEST:-0}
      INSTANCE_ID: 0
      OUTPUT_DIR: /output
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: ./entrypoint_senders.sh

  sender_bravo:
    image: ojmichel/mc-multiplayer-base:latest
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      mc:
        condition: service_healthy
      receiver_bravo:
        condition: service_started
      sender_alpha:
        condition: service_started
    volumes:
      # share the output directory with the host
      - ./output:/output
    environment:
      BOT_NAME: Bravo
      OTHER_BOT_NAME: Alpha
      RECEIVER_HOST: receiver_bravo
      RECEIVER_PORT: 8090
      COORD_PORT: 8100
      OTHER_COORD_HOST: sender_alpha
      OTHER_COORD_PORT: 8100
      BOT_RNG_SEED: "123456"
      EPISODES_NUM: ${EPISODES_NUM:-1}
      EPISODE_START_ID: ${EPISODE_START_ID:-0}
      EPISODE_TYPES: ${EPISODE_TYPES:-all}
      MC_HOST: host.docker.internal
      MC_PORT: ${MC_SERVER_PORT:-25565}
      RCON_HOST: host.docker.internal
      RCON_PORT: ${MC_RCON_PORT:-25575}
      RCON_PASSWORD: research
      WALK_TIMEOUT: 5
      TELEPORT: 1
      TELEPORT_CENTER_X: 0
      TELEPORT_CENTER_Z: 0
      TELEPORT_RADIUS: 3000
      TELEPORT_MIN_DISTANCE: 1000
      BOOTSTRAP_WAIT_TIME: 1
      TELEPORT: ${TELEPORT:-1}
      TELEPORT_RADIUS: ${TELEPORT_RADIUS:-5}
      BOOTSTRAP_WAIT_TIME: ${BOOTSTRAP_WAIT_TIME:-1}
      ENABLE_CAMERA_WAIT: 1
      ITERATIONS_NUM_PER_EPISODE: 5
      MC_VERSION: "1.20.4"
      CAMERA_READY_RETRIES: 300
      CAMERA_READY_CHECK_INTERVAL: 2000
      VIEWER_RENDERING_DISABLED: 1
      VIEWER_RECORDING_INTERVAL: 50
      SMOKE_TEST: ${SMOKE_TEST:-0}
      WORLD_TYPE: ${LEVEL_TYPE:-flat}
      INSTANCE_ID: 0
      OUTPUT_DIR: /output
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: ./entrypoint_senders.sh

  receiver_alpha:
    image: ojmichel/mc-multiplayer-base:latest
    environment:
      PORT: 8090
      NAME: Alpha
      INSTANCE_ID: 0
      EPISODE_START_ID: ${EPISODE_START_ID:-0}
      VIEWER_RENDERING_DISABLED: 1
    tty: true
    volumes:
      # attach the relative directory 'data' to the container's /data path
      - ./output:/output
    command: ./entrypoint_receiver.sh

  receiver_bravo:
    image: ojmichel/mc-multiplayer-base:latest
    environment:
      PORT: 8090
      NAME: Bravo
      INSTANCE_ID: 0
      EPISODE_START_ID: ${EPISODE_START_ID:-0}
      VIEWER_RENDERING_DISABLED: 1
    tty: true
    volumes:
      # attach the relative directory 'data' to the container's /data path
      - ./output:/output
    command: ./entrypoint_receiver.sh

  script:
    image: ojmichel/mc-multiplayer-base:latest
    tty: true
    entrypoint: ["sleep", "infinity"]
    restart: "no"
    volumes:
      - .:/usr/src/app
      - ./output:/output

  camera_alpha:
    image: ojmichel/mineflayer-spectator-client:latest
    build:
      context: ./camera
      dockerfile: Dockerfile
    restart: unless-stopped
    network_mode: host
    depends_on:
      mc:
        condition: service_healthy
    environment:
      MC_VERSION: "1.20.4"
      MC_HOST: "127.0.0.1"
      MC_PORT: "${MC_SERVER_PORT:-25565}"
      CAMERA_NAME: "CameraAlpha"
      DISPLAY: "${CAMERA_ALPHA_DISPLAY:-:99}"
      VNC_PORT: "${CAMERA_ALPHA_VNC_PORT:-5901}"
      NOVNC_PORT: "${CAMERA_ALPHA_NOVNC_PORT:-6901}"
      WIDTH: "1280"
      HEIGHT: "720"
      FPS: "20"
      VNC_PASSWORD: "${VNC_PASSWORD:-research}"
      ENABLE_RECORDING: "1"
      RECORDING_PATH: "/output/camera_alpha.mp4"
    volumes:
      - ./camera/data_alpha:/root
      - ./camera/output_alpha:/output
    extra_hosts:
      - "sessionserver.mojang.com:127.0.0.1"
      - "api.minecraftservices.com:127.0.0.1"
      - "authserver.mojang.com:127.0.0.1"
      - "textures.minecraft.net:127.0.0.1"
      - "pc.realms.minecraft.net:127.0.0.1"

  episode_starter:
    image: node:20
    network_mode: host
    depends_on:
      mc:
        condition: service_healthy
      camera_alpha:
        condition: service_started
    working_dir: /app
    environment:
      RCON_HOST: "127.0.0.1"
      RCON_PORT: "${MC_RCON_PORT:-25575}"
      RCON_PASSWORD: "research"
      EPISODE_START_RETRIES: "60"
      EPISODE_REQUIRED_PLAYERS: "Alpha,CameraAlpha,Bravo,CameraBravo"
      EPISODE_START_COMMAND: "episode start Alpha CameraAlpha technoblade.png Bravo CameraBravo test.png"
    volumes:
      - ./camera/episode_starter.js:/app/episode_starter.js:ro
      - ./camera/package.json:/app/package.json:ro
    command:
      [
        "sh",
        "-c",
        "npm install --omit=dev --no-progress && node episode_starter.js",
      ]

  camera_bravo:
    image: ojmichel/mineflayer-spectator-client:latest
    build:
      context: ./camera
      dockerfile: Dockerfile
    restart: unless-stopped
    network_mode: host
    depends_on:
      mc:
        condition: service_healthy
    environment:
      MC_VERSION: "1.20.4"
      MC_HOST: "127.0.0.1"
      MC_PORT: "${MC_SERVER_PORT:-25565}"
      CAMERA_NAME: "CameraBravo"
      DISPLAY: "${CAMERA_BRAVO_DISPLAY:-:100}"
      VNC_PORT: "${CAMERA_BRAVO_VNC_PORT:-5902}"
      NOVNC_PORT: "${CAMERA_BRAVO_NOVNC_PORT:-6902}"
      WIDTH: "1280"
      HEIGHT: "720"
      FPS: "20"
      VNC_PASSWORD: "${VNC_PASSWORD:-research}"
      ENABLE_RECORDING: "1"
      RECORDING_PATH: "/output/camera_bravo.mp4"
    volumes:
      - ./camera/data_bravo:/root
      - ./camera/output_bravo:/output
    extra_hosts:
      - "sessionserver.mojang.com:127.0.0.1"
      - "api.minecraftservices.com:127.0.0.1"
      - "authserver.mojang.com:127.0.0.1"
      - "textures.minecraft.net:127.0.0.1"
      - "pc.realms.minecraft.net:127.0.0.1"
